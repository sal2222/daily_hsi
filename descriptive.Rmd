---
title: "descriptive"
output: 
  html_document:
   keep_md: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(survival)
library(splines)
library(broom)
library(dlnm)
library(plotly)
library(lubridate)
library(corrplot)
library(table1)
library(rnaturalearth)
library(rnaturalearthdata)
library(rgeos)
library(lwgeom)
library(cowplot)
library(tmap)
library(raster)
library(sf)
library(maps)
library(ggspatial)
library(ggrepel)
library(GGally)
library(fitdistrplus)
library(viridis)
library(janitor)
```


```{r}

daily_indices <- read_rds(file = "data/daily_indices.rds")


# daily_indices <- read_rds(file = "E:/data/daily_indices.rds") %>% 
#   rename(date = `lubridate::date(local_dttm)`) %>% 
#   mutate(wbgt_f_mean = weathermetrics::celsius.to.fahrenheit(wbgt_u_mean),
#          installation = recode(installation, 
#                 `pensacola_nas` = "pensacola",
#                 `portsmouth_nmc` = "portsmouth"))

# write_rds(daily_indices, file = "data/daily_indices.rds")


cc_exposure_df <-
  read_rds(file = "data/cc_exposure_df.rds")

# cc_exposure_df <-
#   read_rds(file = "E:/data/cc_exposure_df.rds") %>% 
#   mutate(wbgt_f_mean = weathermetrics::celsius.to.fahrenheit(wbgt_u_mean))


cc_exposure_df %>% 
  count(installation_name) %>% View() #24 installations


# cc_exposure_df <-
#   cc_exposure_df %>% 
#      mutate(installation_name = as_factor(installation_name),
#        installation_name = recode(installation_name,
#         "mcb_camp_lejeune" = "camp_lejeune",
#         "mcb_camp_pendleton" = "camp_pendleton",
#         "fort_benning_ga" = "fort_benning",
#         "fort_sam_houston" = "jbsa",
#         "mcrd_beaufort_parris_island" = "parris_island",
#         "mcb_quantico" = "quantico",
#         "twentynine_palms_main_base" = "twentynine_palms")) 


# write_rds(cc_exposure_df, file = "data/cc_exposure_df.rds")
# write_rds(daily_indices, file = "data/daily_indices.rds")

```





### Counts by service - installation
```{r}

base_service_counts <-
  cc_exposure_df %>% 
    count(installation_name, service) %>% 
    spread(service, n, fill = 0) 


# rank case occurrence by service for each installation; filter top

base_service_rank <-
  cc_exposure_df %>% 
    count(installation_name, service) %>% 
    group_by(installation_name) %>% 
    mutate(rank = rank(-n)) %>% 
    filter(rank == 1)

base_service_df <-
  base_service_counts %>% 
    right_join(base_service_rank %>% 
                 dplyr::select(installation_name, service), by = "installation_name") 


base_service_df %>% 
  count(service)

```

### Geographic / climate region

https://www.ncdc.noaa.gov/monitoring-references/maps/us-climate-regions.php

Through climate analysis, National Centers for Environmental Information scientists have identified nine climatically consistent regions within the contiguous United States which are useful for putting current climate anomalies into a historical perspective (Karl and Koss, 1984).



```{r}

base_service_df$installation_name

# Assign U.S. Climate regions

## 1st column
installation_name <- base_service_df$installation_name 
## 2nd column
region <- c("Southeast", "Southeast", "Southeast", "Southeast", "Ohio Valley", "South", 
            "Southeast", "West", "South", "West", "Southeast", "South",
            "Southeast", "West", "South", "Ohio Valley", "South", "West",
            "Ohio Valley", "South", "Southeast", "Southeast", "Southeast", "Southeast"
            )

climate_regions <- data.frame(installation_name, region) %>% 
  as_tibble()
  

base_service_df <- 
  base_service_df %>% 
    right_join(climate_regions, by = "installation_name") 


base_service_df <-
  base_service_df %>% 
    mutate(service = recode(service,
          "A" = "Army",
          "C" = "Coast Guard",
          "F" = "Air Force",
          "M" = "Marine Corps",
          "N" = "Navy"))


#write_rds(base_service_df, file = "data/base_service_df.rds")
  


base_service_df %>% 
  ggplot(aes(region)) +
    geom_bar() +
    theme_bw()


base_service_df %>% 
  ggplot(aes(region, fill = service)) +
    geom_bar(position = position_dodge()) +
    theme_bw()


# Cross-tab service and region
base_service_df %>% 
  group_by(service, region) %>% 
  summarise(n = n()) %>% 
  spread(region, n)

base_service_df %>% 
  group_by(service, region) %>% 
  summarise(n = n()) %>% 
  spread(region, n) %>% 
  knitr::kable()
```


## Outcome table
```{r}

to_table1 <-
  cc_exposure_df %>% 
    filter(case == 1) %>% 
    dplyr::select(installation_name, source, age, sex, race_ethnic, service, grade, hsi) %>% 
       mutate(service = recode(service,
            "A" = "Army",
            "C" = "Coast Guard",
            "F" = "Air Force",
            "M" = "Marine Corps",
            "N" = "Navy"),
            source = recode(source,
            "INPATIENT" = "In-Patient",
            "OUTPATIENT" = "Out-Patient",
            "RME" = "Reportable Event"),
            hsi = recode(hsi,
            "heat_exhaustion" = "Heat Exhaustion",
            "heat_stroke" = "Heat Stroke"),
            sex = recode(sex,
            "F" = "Female",
            "M" = "Male",
            "Z" = "Unknown")
            ) %>% 
  left_join(climate_regions, by = "installation_name") %>% 
  mutate_if(is.character, as.factor) %>% 
            mutate(age = fct_relevel(age, ">=40", after = Inf))


label(to_table1$hsi) <- "HSI Diagnosis"
label(to_table1$age) <- "Age Group"
label(to_table1$sex) <- "Sex"
label(to_table1$race_ethnic) <- "Race/Ethnicity"
label(to_table1$grade) <- "Grade Group"
label(to_table1$service) <- "Service Branch"
label(to_table1$region) <- "NOAA NCEI Climate Region"


table1::table1(~ hsi + sex + age + sex + grade + race_ethnic  | source, data = to_table1)
table1::table1(~ hsi + sex + age + sex + grade   | source, data = to_table1)  
table1::table1(~ service + region + race_ethnic | source, data = to_table1)

table1::table1(~ factor(hsi) + factor(age) + factor(sex) + 
               factor(race_ethnic) + factor(grade) | factor(source), data = to_table1)




# Alternate Table 1 (Cases and Controls)


to_table1 <-
  cc_exposure_df %>% 
    dplyr::select(installation_name, case, source, age, sex, race_ethnic, service, grade, hsi) %>% 
       mutate(service = recode(service,
            "A" = "Army",
            "C" = "Coast Guard",
            "F" = "Air Force",
            "M" = "Marine Corps",
            "N" = "Navy"),
            source = recode(source,
            "INPATIENT" = "In-Patient",
            "OUTPATIENT" = "Out-Patient",
            "RME" = "Reportable Event"),
            hsi = recode(hsi,
            "heat_exhaustion" = "Heat Exhaustion",
            "heat_stroke" = "Heat Stroke"),
            sex = recode(sex,
            "F" = "Female",
            "M" = "Male",
            "Z" = "Unknown"),
            case = as_factor(case),
            case = recode(case,
                          "0" = "Control",
                          "1" = "Case")
                      ) %>% 
  left_join(climate_regions %>% 
              mutate(installation_name = janitor::make_clean_names(installation_name)),
            by = "installation_name") %>% 
  mutate_if(is.character, as.factor) %>% 
            mutate(age = fct_relevel(age, ">=40", after = Inf))


label(to_table1$hsi) <- "HSI Diagnosis"
label(to_table1$service) <- "Service Branch"
label(to_table1$region) <- "NOAA NCEI Climate Region"
label(to_table1$case) <- "Case Status"
label(to_table1$source) <- "Encounter Type"

table1::table1(~ hsi + source + service + region | case, data = to_table1)






# Cases over time

cc_exposure_df %>% 
  filter(case == 1) %>% 
  group_by(lubridate::year(date)) %>% 
  count() %>% 
  rename(year = `lubridate::year(date)`) %>% 
  ggplot(aes(x = year, y= n)) +
      geom_point() +
      geom_line(size = 1.5) +
      theme_bw() +
  labs(title = "HSI cases by year",
       x = "year")


cc_exposure_df %>% 
  filter(case == 1) %>% 
  group_by(lubridate::year(date), installation_name) %>% 
  count() %>% 
  rename(year = `lubridate::year(date)`) %>% 
  ggplot(aes(x = year, y = n, colour = installation_name)) +
      geom_point() +
      geom_line(size = 0.8) +
      theme_bw() +
  labs(title = "HSI cases by year",
       x = "year")
```






## Exposures


## Scatterplot (correlogram) by indices
```{r}

cc_exposure_df %>% 
    filter(case == 1) %>% 
  dplyr::select(tmp_f_mean, tmp_f_max, heat_index_mean, heat_index_max, wbgt_mean, wbgt_max) %>% 
  GGally::ggpairs(title = "Correlogram of daily indices for HSI case days, 1998-2019") +
    theme_bw()

#ggsave("output/index_correlogram.png")


# Log transformed indices
cc_exposure_df %>% 
    filter(case == 1) %>% 
  dplyr::select(tmp_f_mean, tmp_f_max, heat_index_mean, heat_index_max, wbgt_mean, wbgt_max) %>%
  log(.) %>% 
  GGally::ggpairs(title = "Correlogram of daily indices (Log transformed) for HSI case days, 1998-2019") +
    theme_bw()
```


### Index distributions

Cullen and Frey graph (square of skewness vs kurtosis)

```{r}

cc_exposure_df %>% 
    filter(case == 1) %>% 
    pull(tmp_f_mean) %>% 
    fitdistrplus::descdist(., boot = 2000)

tmp_mean_vector <-
  cc_exposure_df %>% 
      filter(case == 1) %>% 
      pull(tmp_f_mean) 

tmp_mean_vector %>% 
  fitdist(.,"lnorm") %>% 
  summary()


tmp_mean_vector %>% 
  fitdist(.,"lnorm") %>% 
    plot()


tmp_mean_vector %>% 
 fitdist(., "norm", method = "mme", gof = "CvM") %>% .$aic

tmp_mean_vector %>% 
 fitdist(., "lnorm", method = "mme", gof = "CvM") %>% .$aic

tmp_mean_vector %>% 
 fitdist(., "gamma", method = "mme", gof = "CvM") %>% .$aic

tmp_mean_vector %>% 
 fitdist(., "logis", method = "mme", gof = "CvM") %>% .$aic

tmp_mean_vector %>% 
 fitdist(., "exp", method = "mme", gof = "CvM") %>% .$aic
```






### Density plot
```{r}

#Density plot, all case days 1998-2018, WBGT


to_density_plot <-
  cc_exposure_df %>%
    filter(case == 1) %>% 
    dplyr::select(installation_name, d_event, wbgt_mean, wbgt_max) %>% 
    mutate("Mean WBGT" = weathermetrics::celsius.to.fahrenheit(wbgt_mean),
           "Max WBGT" = weathermetrics::celsius.to.fahrenheit(wbgt_max)) %>% 
    dplyr::select(installation_name, `Mean WBGT`, `Max WBGT`) %>% 
    pivot_longer(-installation_name, names_to = "Index", values_to = "Value")

  
#check for missing values
  to_density_plot[!complete.cases(to_density_plot),]
  
  
to_density_plot %>%   
  ggplot(aes(x = Value, fill = Index, colour = Index)) +
      geom_density(alpha = 0.5) +
      geom_rug() +
      theme_bw() +
  labs(title = "Density plot of daily indices on all case days, 1998-2019",
       x = "Daily Index Value (째F)")


to_density_plot %>% 
  group_by(Index) %>% 
  summarise(Mean = mean(Value),
            SD = sd(Value),
            `75th` = quantile(Value, .75),
            `95th` = quantile(Value, .95),
              max = max(Value),
            IQR = IQR(Value)) %>% 
  knitr::kable()



#Density plot, all case days 1998-2018, Heat Index


to_density_plot <-
  cc_exposure_df %>%
    filter(case == 1) %>% 
    dplyr::select(installation_name, `Mean Heat Index` = heat_index_mean, `Max Heat Index` = heat_index_max) %>% 
    pivot_longer(-installation_name, names_to = "Index", values_to = "Value")

  
#check for missing values
  to_density_plot[!complete.cases(to_density_plot),]
  
  
to_density_plot %>%   
  ggplot(aes(x = Value, fill = Index, colour = Index)) +
      geom_density(alpha = 0.5) +
      geom_rug() +
      theme_bw() +
  labs(title = "Density plot of daily indices on all case days, 1998-2019",
       x = "Daily Index Value (째F)")

to_density_plot %>% 
  group_by(Index) %>% 
  summarise(Mean = mean(Value),
            SD = sd(Value),
            `75th` = quantile(Value, .75),
            `95th` = quantile(Value, .95),
            max = max(Value), 
            IQR = IQR(Value)) %>% 
  knitr::kable()




## Day of year
  # density plot
cc_exposure_df %>%
  filter(case == 1) %>% 
  dplyr::select(installation_name, date) %>% 
  mutate(`Day of Year` = lubridate::yday(date)) %>% 
  ggplot(aes(x = `Day of Year`)) +
  geom_density(colour = "cadetblue", fill = "cadetblue", alpha = 0.5) +
  theme_bw() +
  labs(title = "Day of year for HSI case days, 1998-2019")
    
  # bar plot
cc_exposure_df %>%
  filter(case == 1) %>% 
  dplyr::select(installation_name, date) %>% 
  mutate(`Day of Year` = lubridate::yday(date)) %>% 
  ggplot(aes(x = `Day of Year`)) +
  geom_bar(colour = "cadetblue", fill = "cadetblue", alpha = 0.5) +
  theme_bw() +
  labs(title = "Day of year for HSI case days, 1998-2019")



## Day of year - by year


cc_exposure_df %>%
  filter(case == 1) %>% 
  dplyr::select(installation_name, date) %>% 
  mutate(`Day of Year` = lubridate::yday(date),
         Year = as_factor(lubridate::year(date))) %>% 
  ggplot(aes(x = `Day of Year`, group = Year, color = Year)) +
  geom_density(fill = NA) +
  theme_bw() +
  labs(title = "Day of year for HSI case days, 1998-2019") +
  scale_color_viridis(discrete = TRUE, option = "D")

```

## Temperature indices
```{r}
#Density plot, all case days 1998-2018, Temp


to_density_plot <-
  cc_exposure_df %>%
    filter(case == 1) %>% 
    dplyr::select(installation_name, d_event, tmp_f_mean, tmp_f_max) %>% 
    rename("Mean Temp" = tmp_f_mean,
           "Max Temp" = tmp_f_max) %>% 
    dplyr::select(installation_name, `Mean Temp`, `Max Temp`) %>% 
    pivot_longer(-installation_name, names_to = "Index", values_to = "Value")

  
#check for missing values
  to_density_plot[!complete.cases(to_density_plot),] 
  
to_density_plot %>%   
  ggplot(aes(x = Value, fill = Index, colour = Index)) +
      geom_density(alpha = 0.5) +
      geom_rug() +
      theme_bw() +
  labs(title = "Density plot of daily indices on all case days, 1998-2019",
       x = "Daily Index Value (째F)")


to_density_plot %>% 
  group_by(Index) %>% 
  summarise(Mean = mean(Value),
            SD = sd(Value),
            `75th` = quantile(Value, .75),
            `95th` = quantile(Value, .95),
            max = max(Value),
            IQR = IQR(Value)) %>% 
  knitr::kable()

```

### Density plots - formatted to plot all indices together
```{r}

to_density_plot_all <-
  cc_exposure_df %>%
     mutate("wbgt_mean" = weathermetrics::celsius.to.fahrenheit(wbgt_mean),
           "wbgt_max" = weathermetrics::celsius.to.fahrenheit(wbgt_max)) %>% 
    filter(case == 1) %>% 
    dplyr::select(installation_name, d_event, tmp_f_mean, tmp_f_max,
                  heat_index_mean, heat_index_max,
                  wbgt_mean, wbgt_max) %>%
   pivot_longer(-c(installation_name, d_event), names_to = "Index", values_to = "Value") %>% 
    mutate(index = 
           case_when(
                   Index %in% c("tmp_f_mean", "tmp_f_max") ~ "Temperature",
      Index %in% c("heat_index_mean", "heat_index_max")    ~ "Heat Index",
      Index %in% c("wbgt_mean", "wbgt_max")                  ~ "WBGT"),
          type = 
           case_when(
                   Index %in% c("tmp_f_mean", "heat_index_mean", "wbgt_mean") ~ "Mean",
      Index %in% c("tmp_f_max", "heat_index_max", "wbgt_max")    ~ "Max"),
      index = fct_relevel(index, "Temperature", "Heat Index", "WBGT"),
      type = fct_relevel(type, "Max", "Mean")
    ) 
  
  
to_density_plot_all %>%   
    ggplot(aes(x = Value, fill = type, colour = type)) +
      facet_wrap(~index) +
      geom_density(alpha = 0.5) +
      geom_rug() +
      theme_bw() +
      labs(x = "Daily Index Value (째F)") +
      theme(strip.text.x = element_text(
            size = 12, face = "bold"),
        legend.position = "bottom") +
      scale_x_continuous(breaks = seq(from = 0, to = 120, by = 20))
  
  
#title = "Density plot of daily indices on all case days, 1998-2019"

```


## Summary table: All Indices
```{r}

to_index_table <-
  cc_exposure_df %>%
     mutate("wbgt_mean" = weathermetrics::celsius.to.fahrenheit(wbgt_mean),
           "wbgt_max" = weathermetrics::celsius.to.fahrenheit(wbgt_max)) %>% 
    filter(case == 1) %>% 
    dplyr::select(installation_name, d_event, tmp_f_mean, tmp_f_max,
                  heat_index_mean, heat_index_max,
                  wbgt_mean, wbgt_max) %>%
   pivot_longer(-c(installation_name, d_event), names_to = "Index", values_to = "Value") %>% 
    mutate(index = 
           case_when(
                   Index %in% c("tmp_f_mean", "tmp_f_max") ~ "Temperature",
      Index %in% c("heat_index_mean", "heat_index_max")    ~ "Heat Index",
      Index %in% c("wbgt_mean", "wbgt_max")                  ~ "WBGT"),
          type = 
           case_when(
                   Index %in% c("tmp_f_mean", "heat_index_mean", "wbgt_mean") ~ "Mean",
      Index %in% c("tmp_f_max", "heat_index_max", "wbgt_max")    ~ "Max"),
      index = fct_relevel(index, "Temperature", "Heat Index", "WBGT"),
      type = fct_relevel(type, "Max", "Mean"),
      index_name = paste(index, type, sep = "-")
    ) %>% 
  dplyr::select(installation_name, index_name, Value) %>%
  group_by(index_name) %>% 
  mutate(row = row_number()) %>%
  pivot_wider(names_from = index_name, values_from = Value) %>%
  dplyr::select(-row)
  
  


table1::table1(~ `Temperature-Mean` + `Temperature-Max` + `Heat Index-Mean` +
               `Heat Index-Max` + `WBGT-Mean` + `WBGT-Max`, data = to_index_table)
  
  
    
  knitr::kable()

```





## Map

```{r}

centroid_coords <-
  read_rds("data/centroid_coords.rds")



centroid_coords$site_name 
centroid_coords$geometry 

# convert Installation names from snake-case to "title"
base_service_df <-
  base_service_df %>%
    mutate(installation_name = str_replace_all(installation_name, "_", " "),
      installation_name = str_to_title(installation_name, locale = "en"))

base_service_df$installation_name


# Change `centroid_coords` site names to match

centroid_coords <-
  centroid_coords %>% 
    mutate(site_name = recode(site_name,
                              "Fort Benning GA" = "Fort Benning",
                              "NAS Pensacola" = "Pensacola",
                              "Naval Medical Center Portsmouth" = "Portsmouth",
                              "MCB Quantico" = "Quantico",
                              "MCRD San Diego" = "Mcrd San Diego",
                              "NTC and Fort Irwin" = "Ntc And Fort Irwin",
                              "Twentynine Palms Main Base" = "Twentynine Palms",
                              "MCB Camp Lejeune" = "Camp Lejeune",
                              "Eglin AFB" = "Eglin Afb",
                              "Fort Sam Houston" = "Jbsa",
                              "MCRD Beaufort Parris Island" = "Parris Island",
                              "MCB Camp Pendleton" = "Camp Pendleton"))


mapping_df <-
  base_service_df %>% 
    left_join(centroid_coords, by = c("installation_name" = "site_name"))

#write_rds(mapping_df, file = "data/mapping_df.rds")
                              


mapping_df                              

```


```{r}

point_coords <-
  st_coordinates(mapping_df$centroid) %>% 
    as_tibble() %>% 
    rename("longitude" = "X",
           "latitude" = "Y")


mapping_df <-
  mapping_df %>% bind_cols(
    point_coords)



sites <- data.frame(names = mapping_df$installation_name,
                    longitude = mapping_df$longitude,
                    latitude = mapping_df$latitude,
                    region = mapping_df$region,
                    service = mapping_df$service)


sites <- st_as_sf(sites, coords = c("longitude", "latitude"), remove = FALSE, 
    crs = 4326, agr = "constant")



#world map

world <- ne_countries(scale = "medium", returnclass = "sf")
usa <- ne_countries(country = 'united states of america', scale = "medium", returnclass = "sf")
usa

states <- st_as_sf(map("state", plot = FALSE, fill = TRUE))
states




ggplot(data = usa) +
    geom_sf() +
    geom_sf(data = states, fill = "cornsilk") + 
    geom_point(data = sites, aes(x = longitude, y = latitude, fill = service), size = 4, 
        shape = 23) +
    geom_sf(data = sites) +
    geom_text_repel(data = sites, aes(x = longitude, y = latitude, label = names), fontface = "bold", size = 3, 
        nudge_x = 3, nudge_y = -2) +
    coord_sf(xlim = c(-130, -65), ylim = c(24.5, 50), expand = FALSE) +
    ggtitle("Study Installations", subtitle = "(n=24)") +
    theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
        size = 0.5), panel.background = element_rect(fill = "azure2")) +
    theme(legend.position = "bottom")

# ggsave("output/study_map.png")


# Zoomed-in map

ggplot(data = usa) +
    geom_sf() +
    geom_sf(data = states, fill = "cornsilk") + 
    geom_point(data = sites, aes(x = longitude, y = latitude, fill = service), size = 4, 
        shape = 23) +
    geom_sf(data = sites) +
    geom_text_repel(data = sites, aes(x = longitude, y = latitude, label = names), fontface = "bold", size = 3,
                    nudge_y = 1) +
    labs(title = "min.segment.length = 0") +
    coord_sf(xlim = c(-124, -72), ylim = c(25, 43), expand = FALSE) +
    ggtitle("Study Installations", subtitle = "(n=24)") +
    theme(panel.grid.major = element_line(color = gray(0.5), linetype = "dashed", 
        size = 0.5), panel.background = element_rect(fill = "azure2")) +
    theme(panel.border = element_rect(colour = "black", fill = NA, size = 1),
          legend.position = "bottom")


```





#####################################################################

## Earlier descriptive review
Read in daily NLDAS

```{r, eval = FALSE}

daily_nldas <- read_rds(file = "E:/data/daily_nldas.rds")

```


"Table 1"

```{r, eval = FALSE}


# Outcomes 

cc_exposure_df <-
  read_rds(file = "E:/data/cc_exposure_df.rds")

table1::table1(~ factor(source) + factor(hsi) + factor(service) | case, data = cc_exposure_df)


table1::table1(~ factor(installation_name) | case, data = cc_exposure_df)


# Exposure

nldas_1998 <- daily_nldas %>% 
  filter(lubridate::year(date) %in% 1998:2019)

table1::table1(~ tmp_f_mean + heat_index_mean + Twbg_u_mean | factor(installation), data = nldas_1998)

# Indiv risk factors

table1::table1(~ factor(sex) + factor(age) + factor(grade) + bmi | case, data = cc_exposure_df)


```


Compare WBGT to Temp and Heat Index 
```{r, eval = FALSE}


daily_nldas %>% 
  drop_na %>% 
  filter(lubridate::year(date) %in% 1998:2019) %>% 
  dplyr::select(tmp_f_mean, heat_index_mean, Twbg_u_mean, Tnwb_u_mean) %>% 
  ggplot(aes(x = tmp_f_mean, y = Twbg_u_mean, color = installation)) +
    geom_point(aes(alpha = 0.2, size = 0.2)) +
    geom_smooth(method = "lm") +
    theme_bw()



daily_nldas %>% 
  ungroup() %>% 
  filter(lubridate::year(date) %in% 1998:2019) %>% 
  dplyr::select(tmp_f_mean, heat_index_mean, Twbg_u_mean, Tnwb_u_mean) %>% 
  cor()


daily_nldas %>% 
  filter(lubridate::year(date) %in% 1998:2019) %>% 
  dplyr::select(installation, tmp_f_mean, heat_index_mean, Twbg_u_mean, Tnwb_u_mean) %>% 
  group_by(installation) %>% 
    summarise(r = cor(tmp_f_mean, Twbg_u_mean)) %>% View()

  



```

