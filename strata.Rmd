---
title: "strata"
author: "SL"
date: "6/12/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)


library(tidyverse)
library(purrr)
library(furrr)
library(forecast)
library(dlnm)
library(remotes)
library(case.crossover)
#remotes::install_github("RyanGan/case.crossover")
library(lubridate)



plan(multiprocess) # for use with furrr::future_map; run in parallel

# increase memory storage capacity
# memory.limit()
# memory.limit(size = 56000)
   
```


## Case-crossover strata

```{r create_strata, eval = FALSE}

encounters_nest <-
  read_rds("data/encounters_nest.rds") 
    

encounters_nest %>% 
  unnest(data) %>% 
  
```

# Assign referent/control dates for each case

## Function for control days
```{r}

# https://stackoverflow.com/questions/20676779/create-a-case-control-pair-for-time-stratified-case-crossover-design used as guide for function
  # Referent dates must have the same month and wday as event


ref_dates_fun <- function(d_event) {

    possible_refs <- d_event - lubridate::days(30):d_event + lubridate::days(30)

    possible_refs[month(possible_refs) == lubridate::month(d_event)
                        & wday(possible_refs) == wday(d_event)
                        & d_event != possible_refs]
}


```

## Map function for control days over case dates

```{r}

case_controls <-
  encounters_nest %>% 
    unnest(data) %>% 
    mutate(control_dates = furrr::future_map(.x = d_event, ref_dates_fun))



  
  




```


